<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Free Fire Survival - Tri Kỷ Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; touch-action: none; background: #000; font-family: 'Segoe UI', Arial; }
        #lobby { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); display: flex; justify-content: center; align-items: center; z-index: 1000; text-align: center; }
        #start-btn { padding: 18px 60px; font-size: 28px; background: #ff4500; color: white; border: none; border-radius: 50px; box-shadow: 0 8px #900; font-weight: bold; cursor: pointer; transition: 0.2s; }
        #start-btn:active { transform: translateY(4px); box-shadow: 0 2px #900; }
        
        .btn { position: absolute; border-radius: 50%; border: 2px solid rgba(255,255,255,0.7); color: white; display: flex; align-items: center; justify-content: center; user-select: none; font-weight: bold; background: rgba(0,0,0,0.5); z-index: 10; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        #shoot-btn { bottom: 50px; right: 30px; width: 100px; height: 100px; background: rgba(255,0,0,0.6); font-size: 18px; border: 4px solid #fff; }
        #grenade-btn { bottom: 60px; right: 140px; width: 60px; height: 60px; background: rgba(0,100,0,0.7); }
        #gloo-btn { bottom: 130px; right: 140px; width: 60px; height: 60px; background: rgba(0,150,255,0.7); }
        #jump-btn { bottom: 160px; right: 40px; width: 60px; height: 60px; }
        
        #hp-ui { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 250px; z-index: 20; }
        #hp-bar-bg { width: 100%; height: 12px; background: rgba(0,0,0,0.6); border: 2px solid #fff; border-radius: 10px; overflow: hidden; }
        #hp-bar-fill { width: 100%; height: 100%; background: #00ff00; transition: 0.3s; }
        #ep-bar-fill { width: 0%; height: 6px; background: #ffff00; margin-top: 4px; border-radius: 10px; transition: 0.3s; }
        
        #zone-info { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); color: #fff; font-weight: bold; text-align: center; text-shadow: 2px 2px #000; z-index: 100; }
        #joystick-container { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; z-index: 10; }
        .dmg { position: fixed; color: #ffff00; font-weight: bold; font-size: 26px; pointer-events: none; animation: fly 0.6s ease-out forwards; }
        @keyframes fly { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-60px); } }
    </style>
</head>
<body>

    <div id="lobby">
        <div>
            <h1 style="color: #ffcc00; font-size: 45px; text-shadow: 4px 4px #000; margin-bottom: 30px;">FREE FIRE MOBILE</h1>
            <button id="start-btn">BẮT ĐẦU</button>
        </div>
    </div>

    <div id="zone-info">VÒNG BO: <span id="z-dist">150</span>m<br><span id="z-msg" style="color: #ff3333;"></span></div>
    
    <div id="hp-ui">
        <div id="hp-bar-bg"><div id="hp-bar-fill"></div></div>
        <div id="ep-bar-fill"></div>
    </div>

    <div id="shoot-btn" class="btn">BẮN</div>
    <div id="grenade-btn" class="btn">LỰU</div>
    <div id="gloo-btn" class="btn">KEO</div>
    <div id="jump-btn" class="btn">NHẢY</div>
    <div id="joystick-container"></div>

    <script>
        // --- KHỞI TẠO ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const sun = new THREE.DirectionalLight(0xffffff, 0.9);
        sun.position.set(50, 100, 50);
        scene.add(sun);

        // --- MẶT ĐẤT & NẤM ---
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshPhongMaterial({color: 0x2d5a27}));
        ground.rotation.x = -Math.PI/2;
        scene.add(ground);

        function createMushroom(x, z) {
            const m = new THREE.Group();
            const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 0.5), new THREE.MeshPhongMaterial({color: 0xffffff}));
            const cap = new THREE.Mesh(new THREE.SphereGeometry(0.5, 8, 8, 0, Math.PI*2, 0, Math.PI/2), new THREE.MeshPhongMaterial({color: 0xffff00}));
            cap.position.y = 0.3;
            m.add(stem, cap); m.position.set(x, 0.25, z);
            scene.add(m); return m;
        }
        const mushrooms = [createMushroom(10, 10), createMushroom(-15, -20), createMushroom(20, -5)];

        // --- NHÂN VẬT & BO ---
        let hp = 200, ep = 0, zoneR = 150, isJumping = true;
        const player = new THREE.Group();
        player.add(new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1, 4, 8), new THREE.MeshPhongMaterial({color: 0x00ff00})));
        player.position.set(0, 50, 0); // Bắt đầu từ trên cao để nhảy dù
        scene.add(player);

        const bot = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1, 4, 8), new THREE.MeshPhongMaterial({color: 0xff0000}));
        bot.position.set(10, 1, -15);
        scene.add(bot);

        const zoneMesh = new THREE.Mesh(new THREE.TorusGeometry(zoneR, 1, 16, 100), new THREE.MeshBasicMaterial({color: 0x0000ff, transparent: true, opacity: 0.4}));
        zoneMesh.rotation.x = Math.PI/2; scene.add(zoneMesh);

        // --- LOGIC ---
        let mv = {x:0, y:0}, camY = 0, vY = 0, shootSnd = new Audio('https://actions.google.com/sounds/v1/weapons/firearm_shotgun.ogg');

        document.getElementById('start-btn').onclick = () => {
            document.getElementById('lobby').style.display = 'none';
            vY = -0.1; // Bắt đầu rơi xuống
        };

        nipplejs.create({zone: document.getElementById('joystick-container'), mode:'static', position:{left:'60px', bottom:'60px'}}).on('move', (e,d)=>{mv={x:d.vector.x, y:d.vector.y}}).on('end', ()=>{mv={x:0, y:0}});

        window.addEventListener('touchmove', (e)=>{ if(e.touches[0].clientX > window.innerWidth/2) camY -= e.touches[0].deltaX * 0.005 || 0; });

        document.getElementById('shoot-btn').ontouchstart = (e) => {
            e.preventDefault(); shootSnd.currentTime=0; shootSnd.play();
            const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(0,0), camera);
            if(ray.intersectObject(bot).length > 0) {
                const d = document.createElement('div'); d.className='dmg'; d.innerHTML=35; d.style.left="50%"; d.style.top="45%";
                document.body.appendChild(d); setTimeout(()=>d.remove(), 600);
                bot.position.set(Math.random()*40-20, 1, Math.random()*-40);
            }
        };

        document.getElementById('grenade-btn').onclick = () => {
            const g = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshPhongMaterial({color:0x004400}));
            g.position.copy(player.position).y += 1; scene.add(g);
            let gV = new THREE.Vector3(Math.sin(camY)*-0.4, 0.2, Math.cos(camY)*-0.4);
            let timer = setInterval(()=>{
                g.position.add(gV); gV.y -= 0.015;
                if(g.position.y <= 0) { clearInterval(timer); scene.remove(g); }
            }, 20);
        };

        document.getElementById('gloo-btn').onclick = () => {
            const w = new THREE.Mesh(new THREE.BoxGeometry(4, 2.5, 0.5), new THREE.MeshPhongMaterial({color:0x00ffff, transparent:true, opacity:0.6}));
            w.position.set(player.position.x - Math.sin(camY)*3, 1.25, player.position.z - Math.cos(camY)*3);
            w.rotation.y = camY; scene.add(w); setTimeout(()=>scene.remove(w), 7000);
        };

        document.getElementById('jump-btn').onclick = () => { if(!isJumping) vY = 0.15; };

        // --- VÒNG LẶP GAME ---
        function animate() {
            requestAnimationFrame(animate);
            player.rotation.y = camY;
            player.translateX(mv.x * 0.12); player.translateZ(-mv.y * 0.12);

            player.position.y += vY;
            if(player.position.y > 0) { vY -= 0.006; isJumping = true; } 
            else { player.position.y = 0; vY = 0; isJumping = false; }

            const off = new THREE.Vector3(0, 2.5, 5).applyQuaternion(player.quaternion);
            camera.position.copy(player.position).add(off);
            camera.lookAt(player.position.x, player.position.y+1, player.position.z);

            // Xử lý nấm (Ăn nấm hồi EP)
            mushrooms.forEach((m, i) => {
                if(player.position.distanceTo(m.position) < 1.5) {
                    ep = Math.min(ep + 50, 100); scene.remove(m); mushrooms.splice(i, 1);
                }
            });
            if(ep > 0 && hp < 200) { ep -= 0.05; hp += 0.05; } // EP chuyển thành HP

            // Xử lý Bo
            zoneR -= 0.005; if(zoneR < 10) zoneR = 10;
            zoneMesh.geometry = new THREE.TorusGeometry(zoneR, 1, 16, 100);
            let d = player.position.distanceTo(new THREE.Vector3(0,0,0));
            document.getElementById('z-dist').innerText = Math.floor(zoneR);
            if(d > zoneR) { hp -= 0.15; document.getElementById('z-msg').innerText = "CẢNH BÁO: NGOÀI BO!"; }
            else { document.getElementById('z-msg').innerText = ""; }

            document.getElementById('hp-bar-fill').style.width = (hp/2) + "%";
            document.getElementById('ep-bar-fill').style.width = ep + "%";
            if(hp <= 0) { alert("LOSE!"); location.reload(); }

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
